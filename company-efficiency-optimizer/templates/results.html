{% extends 'base.html' %}
{% block title %}AstraMech - Analysis Results{% endblock %}
{% block meta_description %}Your personalized KPI dashboard with inefficiency analysis and AI-powered recommendations.{% endblock %}
{% block head_extra %}
<style>
    .metric-card {
        background: var(--color-surface);
        border: 1px solid rgba(123, 97, 255, 0.2);
        border-radius: var(--radius-md);
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-strong);
        border-color: var(--color-primary);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--color-primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin: 2rem 0;
        padding: 1rem;
        background: var(--color-surface);
        border-radius: var(--radius-md);
    }
    .efficiency-score {
        font-size: 4rem;
        font-weight: 700;
        background: var(--color-secondary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .status-badge-large {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
    }
    .status-critical { background: rgba(255, 85, 85, 0.2); color: var(--color-danger); }
    .status-warning { background: rgba(255, 176, 32, 0.2); color: var(--color-highlight); }
    .status-good { background: rgba(16, 160, 133, 0.2); color: #16A085; }
    .status-excellent { background: rgba(123, 97, 255, 0.2); color: var(--color-primary); }
    
    .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
    }
</style>
{% endblock %}
{% block content %}

<div class="toast-container" id="toastContainer"></div>

<div class="container py-5">
    <!-- Header with Export Actions -->
    <div class="row mb-5">
        <div class="col-md-8">
            <h2 class="mb-3">Dashboard</h2>
            <p class="lead text-muted">Your personalized KPI dashboard and inefficiency analysis</p>
            <div class="text-muted small">All monetary values are shown in COP.</div>
        </div>
        <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                <a href="{{ url_for('main.export_csv') }}" class="btn btn-outline-primary">
                    <i class="fas fa-file-csv me-2"></i>Export CSV
                </a>
                <a href="{{ url_for('main.export_json') }}" class="btn btn-outline-primary">
                    <i class="fas fa-file-code me-2"></i>Export JSON
                </a>
                <button class="btn btn-outline-primary" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                </button>
            </div>
        </div>
    </div>

    {% if results.error %}
    <!-- Error State -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Analysis Error</h4>
                <p>{{ results.error }}</p>
                <hr>
                <p class="mb-0">Please try again or contact support if the issue persists.</p>
            </div>
            <div class="text-center">
                <a href="{{ url_for('main.questionnaire') }}" class="btn btn-primary">
                    <i class="fas fa-redo me-2"></i>Start New Analysis
                </a>
            </div>
        </div>
    </div>
    {% else %}
    
    <!-- Executive Summary -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="efficiency-score" id="efficiencyScore">0</div>
                            <div class="text-muted">Efficiency Score</div>
                        </div>
                        <div class="col-md-9">
                            <h4 class="mb-3">Executive Summary</h4>
                            <p class="mb-2">
                                {% if results.summary_message %}
                                {{ results.summary_message }}
                                {% else %}
                                <strong>{{ results.company_name }}</strong> analysis complete. 
                                {% if results.kpi_results %}
                                Detected inefficiencies in 
                                <span class="status-badge-large status-warning">Financial Performance</span>
                                {% if results.kpi_results.hr.turnover_rate is not none and results.kpi_results.hr.turnover_rate > 0.15 %}
                                <span class="status-badge-large status-critical">HR Operations</span>
                                {% endif %}
                                {% if results.kpi_results.operational.productivity_index is not none and results.kpi_results.operational.productivity_index < 0.7 %}
                                <span class="status-badge-large status-warning">Operations</span>
                                {% endif %}
                                {% endif %}
                                {% endif %}
                            </p>
                            {% if results.agents and results.agents|length > 0 %}
                            <p class="text-muted mb-0">
                                <strong>{{ results.agents|length }} agentes AI especializados</strong> han sido generados para optimizar tu negocio. Revisa las recomendaciones abajo.
                            </p>
                            {% else %}
                            <p class="text-muted mb-0">
                                AI agents have identified key areas for optimization and generated actionable recommendations below.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="row mb-5">
        <div class="col-md-3 mb-4">
            <div class="metric-card">
                <div class="metric-value">{% if results.kpi_results.financial.gross_margin is not none %}{{ "%.1f"|format(results.kpi_results.financial.gross_margin * 100) }}%{% else %}N/A{% endif %}</div>
                <div class="metric-label">Gross Margin</div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="metric-card">
                <div class="metric-value">{% if results.kpi_results.financial.operating_margin is not none %}{{ "%.1f"|format(results.kpi_results.financial.operating_margin * 100) }}%{% else %}N/A{% endif %}</div>
                <div class="metric-label">Operating Margin</div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="metric-card">
                <div class="metric-value">{% if results.kpi_results.financial.revenue_per_employee %}COP {{ "{:,.0f}".format(results.kpi_results.financial.revenue_per_employee) }}{% else %}N/A{% endif %}</div>
                <div class="metric-label">Revenue/Employee (COP)</div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="metric-card">
                <div class="metric-value">{% if results.kpi_results.operational.productivity_index is not none %}{{ "%.1f"|format(results.kpi_results.operational.productivity_index * 100) }}%{% else %}N/A{% endif %}</div>
                <div class="metric-label">Productivity Index</div>
            </div>
        </div>
    </div>
    <div class="text-muted small mb-4">N/A = data not available</div>

    <!-- Visualizations -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>KPIs vs Industry Benchmarks</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="kpiComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Performance Radar</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed KPI Analysis -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <!-- Financial KPIs -->
            <div class="card mb-4" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Financial Performance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Gross Margin <i class="fas fa-info-circle text-muted" title="(Revenue - COGS) / Revenue"></i></span>
                                <span class="fw-bold {% if results.kpi_results.financial.gross_margin is not none %}status-{{ 'good' if results.kpi_results.financial.gross_margin > 0.3 else 'warning' if results.kpi_results.financial.gross_margin > 0.2 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.financial.gross_margin is not none %}{{ "%.1f"|format(results.kpi_results.financial.gross_margin * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {% if results.kpi_results.financial.gross_margin is not none %}{{ results.kpi_results.financial.gross_margin * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Operating Margin <i class="fas fa-info-circle text-muted" title="Operating Income / Revenue"></i></span>
                                <span class="fw-bold {% if results.kpi_results.financial.operating_margin is not none %}status-{{ 'good' if results.kpi_results.financial.operating_margin > 0.15 else 'warning' if results.kpi_results.financial.operating_margin > 0.1 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.financial.operating_margin is not none %}{{ "%.1f"|format(results.kpi_results.financial.operating_margin * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {% if results.kpi_results.financial.operating_margin is not none %}{{ results.kpi_results.financial.operating_margin * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Net Margin <i class="fas fa-info-circle text-muted" title="Net Income / Revenue"></i></span>
                                <span class="fw-bold {% if results.kpi_results.financial.net_margin is not none %}status-{{ 'good' if results.kpi_results.financial.net_margin > 0.1 else 'warning' if results.kpi_results.financial.net_margin > 0.05 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.financial.net_margin is not none %}{{ "%.1f"|format(results.kpi_results.financial.net_margin * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {% if results.kpi_results.financial.net_margin is not none %}{{ results.kpi_results.financial.net_margin * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Revenue per Employee <i class="fas fa-info-circle text-muted" title="Revenue / Employee Count (COP)"></i></span>
                                <span class="fw-bold">{% if results.kpi_results.financial.revenue_per_employee %}COP {{ "{:,.0f}".format(results.kpi_results.financial.revenue_per_employee) }}{% else %}N/A{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HR KPIs -->
            <div class="card mb-4" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Human Resources</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Turnover Rate <i class="fas fa-info-circle text-muted" title="Employees who left / Average headcount (12 months)"></i></span>
                                <span class="fw-bold {% if results.kpi_results.hr.turnover_rate is not none %}status-{{ 'good' if results.kpi_results.hr.turnover_rate < 0.1 else 'warning' if results.kpi_results.hr.turnover_rate < 0.2 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.hr.turnover_rate is not none %}{{ "%.1f"|format(results.kpi_results.hr.turnover_rate * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: {% if results.kpi_results.hr.turnover_rate is not none %}{{ results.kpi_results.hr.turnover_rate * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total Employees <i class="fas fa-info-circle text-muted" title="Estimated from HR data or payroll if HR data is missing"></i></span>
                                <span class="fw-bold">{% if results.kpi_results.hr.total_employees %}{{ results.kpi_results.hr.total_employees }}{% else %}N/A{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operational KPIs -->
            <div class="card mb-4" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Operational Efficiency</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Cost Efficiency Ratio <i class="fas fa-info-circle text-muted" title="1 - (Operating Expenses / Revenue)"></i></span>
                                <span class="fw-bold {% if results.kpi_results.operational.cost_efficiency_ratio is not none %}status-{{ 'good' if results.kpi_results.operational.cost_efficiency_ratio > 0.8 else 'warning' if results.kpi_results.operational.cost_efficiency_ratio > 0.6 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.operational.cost_efficiency_ratio is not none %}{{ "%.1f"|format(results.kpi_results.operational.cost_efficiency_ratio * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {% if results.kpi_results.operational.cost_efficiency_ratio is not none %}{{ results.kpi_results.operational.cost_efficiency_ratio * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Productivity Index <i class="fas fa-info-circle text-muted" title="Revenue per Employee / Benchmark"></i></span>
                                <span class="fw-bold {% if results.kpi_results.operational.productivity_index is not none %}status-{{ 'good' if results.kpi_results.operational.productivity_index > 0.8 else 'warning' if results.kpi_results.operational.productivity_index > 0.6 else 'critical' }}{% endif %}">
                                    {% if results.kpi_results.operational.productivity_index is not none %}{{ "%.1f"|format(results.kpi_results.operational.productivity_index * 100) }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {% if results.kpi_results.operational.productivity_index is not none %}{{ results.kpi_results.operational.productivity_index * 100 }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- File Summary -->
            <div class="card mb-4" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Uploaded Files</h5>
                </div>
                <div class="card-body">
                    {% for filename, summary in results.file_summary.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-truncate">{{ filename }}</span>
                        <small class="text-muted">{{ summary }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('main.questionnaire') }}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-redo me-2"></i>Run New Analysis
                    </a>
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                    <button class="btn btn-outline-secondary w-100" onclick="shareResults()">
                        <i class="fas fa-share me-2"></i>Share Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendations -->
    {% if results.diagnostic_results %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Agent Recommendations</h5>
                </div>
                <div class="card-body">
                    {% if results.diagnostic_results.summary %}
                    <div class="alert alert-info mb-4" style="background: rgba(123, 97, 255, 0.1); border-color: rgba(123, 97, 255, 0.3);">
                        <strong>Analysis Summary:</strong> {{ results.diagnostic_results.summary }}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card" style="background: var(--color-surface-alt); border-left: 4px solid var(--color-primary);">
                                <div class="card-body">
                                    <h6><i class="fas fa-chart-line me-2"></i>Financial Optimization</h6>
                                    <p class="mb-0 small">Based on your current margins, consider implementing cost reduction strategies in operational expenses to improve net margin.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card" style="background: var(--color-surface-alt); border-left: 4px solid var(--color-secondary);">
                                <div class="card-body">
                                    <h6><i class="fas fa-users me-2"></i>HR Improvements</h6>
                                    <p class="mb-0 small">Your turnover rate suggests implementing employee retention programs and improving workplace culture.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card" style="background: var(--color-surface-alt); border-left: 4px solid var(--color-highlight);">
                                <div class="card-body">
                                    <h6><i class="fas fa-cogs me-2"></i>Process Efficiency</h6>
                                    <p class="mb-0 small">Consider automating routine tasks and optimizing workflows to improve productivity index.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
    
    <!-- Next Steps Section -->
    {% if results.kpi_results and results.kpi_results.inefficiencies %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Próximos Pasos Inmediatos</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Acciones prioritarias basadas en tu análisis. Empieza por estas para maximizar el impacto:</p>
                    <div class="row">
                        {% for ineff in results.kpi_results.inefficiencies[:5] %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100" style="background: var(--color-surface-alt); border-left: 4px solid {% if ineff.severity == 'critical' %}var(--color-danger){% elif ineff.severity == 'high' %}var(--color-highlight){% else %}var(--color-primary){% endif %};">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-{% if ineff.severity == 'critical' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                            {{ ineff.issue_type|replace('_', ' ')|title }}
                                        </h6>
                                        <span class="badge {% if ineff.severity == 'critical' %}bg-danger{% elif ineff.severity == 'high' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ ineff.severity|upper if ineff.severity else 'MEDIA' }}
                                        </span>
                                    </div>
                                    <p class="small mb-2">{{ ineff.description }}</p>
                                    {% if ineff.recommended_agent %}
                                    <p class="small text-primary mb-0">
                                        <i class="fas fa-robot me-1"></i>Agente recomendado: <strong>{{ ineff.recommended_agent }}</strong>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- AI Agents Section with Action Plan -->
    {% if results.agents and results.agents|length > 0 %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-header" style="background: var(--color-surface-alt);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Plan de Acción de 90 Días</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="activateAllAgents()">
                            <i class="fas fa-play me-1"></i>Activar Todos los Agentes
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Cada agente tiene tareas específicas y medibles. Marca las tareas completadas para hacer seguimiento de tu progreso.</p>
                    <div class="row">
                        {% for agent in results.agents %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100" style="background: var(--color-surface-alt); border-left: 4px solid {% if agent.priority == 'CRÍTICO' %}var(--color-danger){% elif agent.priority == 'Alta' %}var(--color-primary){% else %}var(--color-secondary){% endif %};">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-0">
                                                <i class="fas fa-robot me-2" style="color: var(--color-primary);"></i>{{ agent.name }}
                                            </h6>
                                            <p class="text-muted small mb-0"><strong>Rol:</strong> {{ agent.role }}</p>
                                        </div>
                                        <span class="badge {% if agent.priority == 'CRÍTICO' %}bg-danger{% elif agent.priority == 'Alta' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ agent.priority }}
                                        </span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong class="small">Objetivo (90 días):</strong>
                                        <p class="small mb-0">{{ agent.goal }}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong class="small">Tareas:</strong>
                                            <span class="badge bg-secondary" id="progress-{{ loop.index0 }}">
                                                0/{{ agent.tasks|length }} completadas
                                            </span>
                                        </div>
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div class="progress-bar" id="progress-bar-{{ loop.index0 }}" style="width: 0%"></div>
                                        </div>
                                        <div class="task-list">
                                            {# Capture agent index before inner loop - Jinja2 doesn't support loop.parent #}
                                            {% set agent_index = loop.index0 %}
                                            {% for task in agent.tasks %}
                                            <div class="form-check mb-2 task-item" data-agent-index="{{ agent_index }}" data-task-index="{{ loop.index0 }}">
                                                <input class="form-check-input task-checkbox" type="checkbox" 
                                                       id="task-{{ agent_index }}-{{ loop.index0 }}"
                                                       onchange="updateTaskProgress({{ agent_index }}, {{ loop.index0 }}, this.checked)">
                                                <label class="form-check-label small {% if false %}text-decoration-line-through text-muted{% endif %}" 
                                                       for="task-{{ agent_index }}-{{ loop.index0 }}">
                                                    {{ task }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 pt-3 border-top">
                                        <p class="mb-0 small">
                                            <i class="fas fa-bullseye me-1 text-primary"></i>
                                            <strong>Métrica de éxito:</strong> 
                                            <span class="text-primary">{{ agent.success_metric }}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card" style="background: var(--color-surface); border: 1px solid rgba(123, 97, 255, 0.2);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h6 class="mb-1">¿Qué quieres hacer ahora?</h6>
                            <p class="text-muted small mb-0">Guarda este análisis o inicia uno nuevo</p>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="saveAnalysis()">
                                <i class="fas fa-save me-2"></i>Guardar Análisis
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportFullReport()">
                                <i class="fas fa-file-pdf me-2"></i>Exportar Reporte Completo
                            </button>
                            <form method="POST" action="{{ url_for('main.clear_session') }}" style="display: inline;">
                                <button type="submit" class="btn btn-primary" onclick="return confirm('¿Estás seguro de que quieres iniciar un nuevo análisis? Esto limpiará los datos actuales.');">
                                    <i class="fas fa-plus me-2"></i>Nuevo Análisis
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Task tracking functionality
let taskProgress = {};

function initializeTaskProgress() {
    // Initialize progress tracking for each agent
    {% if results.agents %}
    {% for agent in results.agents %}
    taskProgress[{{ loop.index0 }}] = {
        total: {{ agent.tasks|length }},
        completed: 0,
        tasks: {}
    };
    {% endfor %}
    {% endif %}
    
    // Load saved progress from localStorage
    const savedProgress = localStorage.getItem('astramech_task_progress');
    if (savedProgress) {
        try {
            const parsed = JSON.parse(savedProgress);
            Object.keys(parsed).forEach(agentIndex => {
                if (taskProgress[agentIndex]) {
                    taskProgress[agentIndex] = parsed[agentIndex];
                    // Restore checkboxes
                    Object.keys(parsed[agentIndex].tasks).forEach(taskIndex => {
                        const checkbox = document.getElementById(`task-${agentIndex}-${taskIndex}`);
                        if (checkbox && parsed[agentIndex].tasks[taskIndex]) {
                            checkbox.checked = true;
                            const label = checkbox.closest('.task-item').querySelector('label');
                            if (label) {
                                label.classList.add('text-decoration-line-through', 'text-muted');
                            }
                        }
                    });
                    updateProgressBar(parseInt(agentIndex));
                }
            });
        } catch (e) {
            console.error('Error loading saved progress:', e);
        }
    }
}

function updateTaskProgress(agentIndex, taskIndex, completed) {
    if (!taskProgress[agentIndex]) {
        taskProgress[agentIndex] = { total: 0, completed: 0, tasks: {} };
    }
    
    taskProgress[agentIndex].tasks[taskIndex] = completed;
    taskProgress[agentIndex].completed = Object.values(taskProgress[agentIndex].tasks).filter(t => t).length;
    
    // Update UI
    const checkbox = document.getElementById(`task-${agentIndex}-${taskIndex}`);
    if (checkbox) {
        const label = checkbox.closest('.task-item').querySelector('label');
        if (label) {
            if (completed) {
                label.classList.add('text-decoration-line-through', 'text-muted');
            } else {
                label.classList.remove('text-decoration-line-through', 'text-muted');
            }
        }
    }
    
    updateProgressBar(agentIndex);
    saveTaskProgress();
}

function updateProgressBar(agentIndex) {
    const progress = taskProgress[agentIndex];
    if (!progress) return;
    
    const percentage = (progress.completed / progress.total) * 100;
    const progressBar = document.getElementById(`progress-bar-${agentIndex}`);
    const progressText = document.getElementById(`progress-${agentIndex}`);
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.classList.remove('bg-secondary', 'bg-warning', 'bg-success');
        if (percentage === 100) {
            progressBar.classList.add('bg-success');
        } else if (percentage >= 50) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-secondary');
        }
    }
    
    if (progressText) {
        progressText.textContent = `${progress.completed}/${progress.total} completadas`;
    }
}

function saveTaskProgress() {
    localStorage.setItem('astramech_task_progress', JSON.stringify(taskProgress));
}

function activateAllAgents() {
    {% if results.agents %}
    {% for agent in results.agents %}
    {% set agent_index = loop.index0 %}
    {% for task in agent.tasks %}
    const checkbox_{{ agent_index }}_{{ loop.index0 }} = document.getElementById('task-{{ agent_index }}-{{ loop.index0 }}');
    if (checkbox_{{ agent_index }}_{{ loop.index0 }} && !checkbox_{{ agent_index }}_{{ loop.index0 }}.checked) {
        checkbox_{{ agent_index }}_{{ loop.index0 }}.checked = true;
        updateTaskProgress({{ agent_index }}, {{ loop.index0 }}, true);
    }
    {% endfor %}
    {% endfor %}
    {% endif %}
    
    showToast('Todos los agentes han sido activados. ¡Empieza a trabajar en las tareas!', 'success');
}

function saveAnalysis() {
    const analysisData = {
        company: '{{ results.company_name }}',
        date: new Date().toISOString(),
        efficiency_score: document.getElementById('efficiencyScore') ? document.getElementById('efficiencyScore').textContent : 'N/A',
        agents: {{ results.agents | tojson if results.agents else '[]' }},
        task_progress: taskProgress
    };
    
    const savedAnalyses = JSON.parse(localStorage.getItem('astramech_saved_analyses') || '[]');
    savedAnalyses.push(analysisData);
    localStorage.setItem('astramech_saved_analyses', JSON.stringify(savedAnalyses));
    
    showToast('Análisis guardado exitosamente. Puedes acceder a él desde el historial.', 'success');
}

function exportFullReport() {
    const report = {
        company: '{{ results.company_name }}',
        date: new Date().toISOString(),
        efficiency_score: document.getElementById('efficiencyScore') ? document.getElementById('efficiencyScore').textContent : 'N/A',
        kpis: {{ results.kpi_results | tojson if results.kpi_results else '{}' }},
        agents: {{ results.agents | tojson if results.agents else '[]' }},
        task_progress: taskProgress,
        summary: '{{ results.summary_message | safe if results.summary_message else "" }}'
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `astramech-report-{{ results.company_name }}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Reporte completo exportado exitosamente.', 'success');
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    toast.role = 'alert';
    toast.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    initializeTaskProgress();
    
    {% if not results.error and results.kpi_results %}
    const results = {{ results | tojson }};
    
    // Calculate Efficiency Score (0-100)
    const calculateEfficiencyScore = () => {
        const financial = results.kpi_results.financial;
        const hr = results.kpi_results.hr;
        const operational = results.kpi_results.operational;
        
        let score = 0;
        score += (financial.gross_margin * 30);
        score += (financial.operating_margin * 25);
        score += (financial.net_margin * 20);
        score += ((1 - hr.turnover_rate) * 15);
        score += (operational.productivity_index * 10);
        
        return Math.min(100, Math.max(0, score * 100));
    };
    
    const efficiencyScore = calculateEfficiencyScore();
    document.getElementById('efficiencyScore').textContent = Math.round(efficiencyScore);
    
    // Animate score
    let currentScore = 0;
    const increment = efficiencyScore / 50;
    const timer = setInterval(() => {
        currentScore += increment;
        if (currentScore >= efficiencyScore) {
            currentScore = efficiencyScore;
            clearInterval(timer);
        }
        document.getElementById('efficiencyScore').textContent = Math.round(currentScore);
    }, 30);
    
    // KPI Comparison Chart
    const ctx1 = document.getElementById('kpiComparisonChart');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Gross Margin', 'Operating Margin', 'Net Margin', 'Productivity'],
                datasets: [{
                    label: 'Your Company',
                    data: [
                        results.kpi_results.financial.gross_margin * 100,
                        results.kpi_results.financial.operating_margin * 100,
                        results.kpi_results.financial.net_margin * 100,
                        results.kpi_results.operational.productivity_index * 100
                    ],
                    backgroundColor: 'rgba(123, 97, 255, 0.8)',
                    borderColor: '#7B61FF',
                    borderWidth: 1
                }, {
                    label: 'Industry Benchmark',
                    data: [30, 15, 10, 80],
                    backgroundColor: 'rgba(0, 200, 255, 0.5)',
                    borderColor: '#00C8FF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#B5BEDF' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#B5BEDF' },
                        grid: { color: 'rgba(123, 97, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#B5BEDF' },
                        grid: { color: 'rgba(123, 97, 255, 0.1)' }
                    }
                }
            }
        });
    }
    
    // Performance Radar Chart
    const ctx2 = document.getElementById('performanceRadarChart');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'radar',
            data: {
                labels: ['Financial', 'HR', 'Operations', 'Efficiency', 'Growth'],
                datasets: [{
                    label: 'Performance',
                    data: [
                        (results.kpi_results.financial.gross_margin + results.kpi_results.financial.operating_margin) / 2 * 100,
                        (1 - results.kpi_results.hr.turnover_rate) * 100,
                        results.kpi_results.operational.productivity_index * 100,
                        results.kpi_results.operational.cost_efficiency_ratio * 100,
                        70 // Placeholder for growth
                    ],
                    backgroundColor: 'rgba(123, 97, 255, 0.2)',
                    borderColor: '#7B61FF',
                    borderWidth: 2,
                    pointBackgroundColor: '#7B61FF',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#7B61FF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#B5BEDF' }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#B5BEDF', backdropColor: 'transparent' },
                        grid: { color: 'rgba(123, 97, 255, 0.1)' },
                        pointLabels: { color: '#B5BEDF' }
                    }
                }
            }
        });
    }
    {% endif %}
});

// Export Functions
function exportToCSV() {
    window.location.href = "{{ url_for('main.export_csv') }}";
    showToast('CSV export initiated...', 'success');
}

function exportToPDF() {
    window.print();
    showToast('PDF export initiated. Use browser print dialog.', 'info');
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'AstraMech Analysis Results',
            text: 'Check out my company efficiency analysis!',
            url: window.location.href
        }).then(() => showToast('Results shared!', 'success'))
        .catch(() => showToast('Share cancelled', 'info'));
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showToast('Link copied to clipboard!', 'success');
        });
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    toast.style.position = 'fixed';
    toast.style.top = '80px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
